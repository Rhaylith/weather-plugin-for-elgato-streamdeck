<!DOCTYPE HTML>
<html>

<head>
    <title>com.tarikguney.weather</title>
    <meta charset="utf-8"/>
    <script src="common.js"></script>
    <script src="moment.js"></script>
</head>

<body>
<script>

    if ($SD) {
        var action = null;
        var context = null;
        var weatherEndpoint = "http://api.openweathermap.org/data/2.5/weather?zip={zipCode},us&appid=e2d4dca5dc8d0f1a430e43a85385c983";

        $SD.on("connected", function (jsonObj) {
            var event = jsonObj['event'];
            action = jsonObj['action'];
            context = jsonObj['context'];
            var jsonPayload = jsonObj['payload'] || {};

            if (event === "willAppear") {
               
            }

            if (event === "didReceiveSettings") {
               
            }

            if (event === "sendToPlugin") {
               
            }
        });

        $SD.on("willAppear", function (jsonObj) {
            $SD.api.getSettings(context);
        });

        $SD.on("didReceiveSettings", function (jsonPayload) {
            if (jsonPayload.settings.hasOwnProperty("lastCheckTime")) {
                var lastCheckTime = jsonPayload.settings.lastCheckTime;
                if (moment().diff(lastCheckTime, "hours") >= 1) {
                    $SD.api.setSettings(context, {lastCheckTime: moment()});
                    getWeather();
                }
            } else {
                $SD.api.setSettings(context, {lastCheckTime: moment()});
                getWeather();
            }
        });

        $SD.on("sentToPlugin", function (jsonPayload) {
            weatherEndpoint = weatherEndpoint.replace("{zipCode}", jsonPayload.zipCode);
            $SD.api.getSettings(context);
        });

        function getWeather() {
            var weatherAjax = new XMLHttpRequest();
            weatherAjax.open("GET", weatherEndpoint);

            $SD.api.setTitle(context, "Updating\nWeather\Info");

            weatherAjax.onreadystatechange = function () {
                if (weatherAjax.readyState === 4 && weatherAjax.status === 200) {
                    weatherAjax.responseText
                    var response = JSON.parse(weatherAjax.responseText);
                    $SD.setTitle(context, response.main.temp);
                }
            }
        }
    }

</script>

</body>

</html>
