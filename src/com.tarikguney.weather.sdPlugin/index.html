<!DOCTYPE HTML>
<html>

<head>
    <title>com.tarikguney.weather</title>
    <meta charset="utf-8"/>
    <script src="common.js"></script>
    <script src="moment.js"></script>
</head>

<body>
<script>

    var interval;

    if ($SD) {
        const actionName = "com.tarikguney.weather.action";

        $SD.on("connected", function (jsonObj) {
            console.log("Connected!");
        });

        $SD.on(actionName + ".willAppear", function (jsonObj) {
            $SD.api.getSettings(jsonObj.context);
        });

        $SD.on(actionName + ".sendToPlugin", function (jsonObj) {
            $SD.api.setSettings(jsonObj.context, {
                zipCode: jsonObj.payload.zipCode,
                apiKey: jsonObj.payload.apiKey
            });

            if (interval) {
                clearInterval(interval);
            }

            // Initial call for the first time, then schedule for every 1 hours.
            setTitleWithWeather(jsonObj.context, jsonObj.payload.apiKey, jsonObj.payload.zipCode);

            interval = setInterval(() => {
                    // Enclosing the variables to avoid closure issues.
                    let context = jsonObj.context;
                    let apiKey = jsonObj.payload.apiKey;
                    let zipCode = jsonObj.payload.zipCode;

                    setTitleWithWeather(context, apiKey, zipCode);
                },
                moment.duration(1, 'hours').asMilliseconds());
        });

        function setTitleWithWeather(context, apiKey, zipCode) {
            $SD.api.setTitle(context, "Updating...");
            getLocationCode(zipCode, apiKey, result => {
                if (!result.hasOwnProperty("Mood")) {
                    $SD.api.setTitle(context, result);
                    return;
                }
                
                $SD.api.setTitle(context, result.Mood.replace(new RegExp(' ', 'g'), '\n') + 
                    "\n" + result.Temperature.Value + " " + result.Temperature.Unit);
                
                let url = "https://developer.accuweather.com/sites/default/files/{Icon}-s.png";
                toDataURL(url.replace("{Icon}", result.Icon),
                    function (dataUrl) {
                        $SD.api.setImage(context, dataUrl);
                    }
                );
            });
        }

        function getLocationCode(zipCode, apiKey, updateTitleFn) {
            let locationEndPoint = "http://dataservice.accuweather.com/locations/v1/postalcodes/us/search?apikey={apiKey}&q={zipCode}";
            let call = new XMLHttpRequest();
            call.open("GET", locationEndPoint.replace("{apiKey}", apiKey).replace("{zipCode}", zipCode));
            call.onreadystatechange = function () {
                if (call.readyState === 4 && call.status === 200) {
                    let response = JSON.parse(call.responseText);
                    let locationKey = response[0].Key;

                    getWeather(apiKey, locationKey, updateTitleFn);
                } else if (call.readyState === 4 && call.status === 503) {
                    // Exceeded the number of allowed calls from AccuWeather Free API.
                    updateTitleFn("Exceeded...!")
                } else if (call.readyState === 4) {
                    updateTitleFn("Error!\nTry again\nlater!")
                }
            };

            call.send();
        }

        function getWeather(apiKey, locationKey, updateTitleFn) {
            let endpoint = "http://dataservice.accuweather.com/forecasts/v1/hourly/1hour/{locationKey}?apikey={apiKey}";
            let call = new XMLHttpRequest();
            call.open("GET", endpoint.replace("{apiKey}", apiKey).replace("{locationKey}", locationKey));

            call.onreadystatechange = function () {
                if (call.readyState === 4 && call.status === 200) {
                    let response = JSON.parse(call.responseText);
                    updateTitleFn({
                        "Mood": response[0].IconPhrase,
                        "Icon": response[0].WeatherIcon,
                        "Temperature": response[0].Temperature
                    });
                } else if (call.readyState === 4 && call.status === 503) {
                    // Exceeded the number of allowed calls from AccuWeather Free API.
                    updateTitleFn("Exceeded...!")
                } else if (call.readyState === 4) {
                    updateTitleFn("Error!\nTry again\nlater!")
                }
            };

            call.send();
        }

        function toDataURL(src, callback, outputFormat) {
            let img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function () {
                let canvas = document.createElement('CANVAS');
                let ctx = canvas.getContext('2d');
                let dataURL;
                canvas.height = this.naturalHeight;
                canvas.width = this.naturalWidth;
                ctx.drawImage(this, 0, 0);
                dataURL = canvas.toDataURL(outputFormat);
                callback(dataURL);
            };
            img.src = src;
            if (img.complete || img.complete === undefined) {
                img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
                img.src = src;
            }
        }
    }

</script>

</body>

</html>
