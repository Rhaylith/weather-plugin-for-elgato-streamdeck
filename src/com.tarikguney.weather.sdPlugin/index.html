<!DOCTYPE HTML>
<html>

<head>
    <title>com.tarikguney.weather</title>
    <meta charset="utf-8"/>
    <script src="common.js"></script>
    <script src="moment.js"></script>
</head>

<body>
<script>

    if ($SD) {
        const actionName = "com.tarikguney.weather.action";

        $SD.on("connected", function (jsonObj) {
            console.log("Connected!");
        });

        $SD.on(actionName + ".willAppear", function (jsonObj) {
            $SD.api.getSettings(jsonObj.context);
        });

        $SD.on(actionName + ".sendToPlugin", function (jsonObj) {
            $SD.api.setSettings(jsonObj.context, {
                zipCode: jsonObj.payload.zipCode,
                apiKey: jsonObj.payload.apiKey
            });

            // Initial call for the first time, then schedule for every 1 hours.
            setTitleWithWeather(jsonObj.context, jsonObj.payload.zipCode, jsonObj.payload.apiKey)
            setInterval(() => setTitleWithWeather(jsonObj.context, jsonObj.payload.zipCode, jsonObj.payload.apiKey),
                moment.duration(1, 'hours').asMilliseconds());

            $SD.api.getSettings(jsonObj.context);
        });

        function setTitleWithWeather(context, apiKey, zipCode) {
            $SD.api.setTitle(context, "Updating...");
            getLocationCode(zipCode, apiKey, result => {
                if (result === "error") {
                    $SD.api.setTitle(context, "Error");
                }
                $SD.api.setTitle(context, result.Mood + "\n" + result.Temperature.Value + " " + result.Temperature.Unit);
            });
        }

        function getWeather(apiKey, locationKey, updateTitleFn) {
            let endpoint = "http://dataservice.accuweather.com/forecasts/v1/hourly/1hour/{locationKey}?apikey={apiKey}";
            let call = new XMLHttpRequest();
            call.open("GET", endpoint.replace("{apiKey}", apiKey).replace("{locationKey}", locationKey));

            call.onreadystatechange = function () {
                if (call.readyState === 4 && call.status === 200) {
                    let response = JSON.parse(call.responseText);
                    updateTitleFn({"Mood": response[0].IconPhrase, "Temperature": response[0].Temperature});
                } else {
                    updateTitleFn("error");
                }
            };

            call.send();
        }

        function getLocationCode(zipCode, apiKey, updateTitleFn) {
            let locationEndPoint = "http://dataservice.accuweather.com/locations/v1/postalcodes/us/search?apikey={apiKey}&q={zipCode}";
            let call = new XMLHttpRequest();
            call.open("GET", locationEndPoint.replace("{apiKey}", apiKey).replace("{zipCode}", zipCode));
            call.onreadystatechange = function () {
                if (call.readyState === 4 && call.status === 200) {
                    let response = JSON.parse(call.responseText);
                    let locationKey = response[0].Key;

                    getWeather(apiKey, locationKey, updateTitleFn);
                }
            };

            call.send();
        }
    }

</script>

</body>

</html>
