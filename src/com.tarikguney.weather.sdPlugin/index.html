<!DOCTYPE HTML>
<html>

<head>
    <title>com.tarikguney.weather</title>
    <meta charset="utf-8"/>
    <script src="common.js"></script>
    <script src="moment.js"></script>
</head>

<body>
<script>

    if ($SD) {
        var actionName = "com.tarikguney.weather.action"
        var weatherEndpoint = "http://api.openweathermap.org/data/2.5/weather?zip={zipCode},us&appid=e2d4dca5dc8d0f1a430e43a85385c983";

        $SD.on("connected", function (jsonObj) {
            console.log("Connected!");
        });

        $SD.on(actionName + ".willAppear", function (jsonObj) {
            $SD.api.getSettings(jsonObj.context);
        });

        $SD.on(actionName + ".didReceiveSettings", function (jsonObj) {
            var jsonPayload = jsonObj.payload;
            if (jsonPayload.settings.hasOwnProperty("lastCheckTime")) {
                var lastCheckTime = jsonPayload.settings.lastCheckTime;
                if (moment().diff(lastCheckTime, "hours") >= 1) {
                    $SD.api.setSettings(jsonObj.context, {lastCheckTime: moment()});
                    getWeather(jsonObj.context);
                }
            } else {
                $SD.api.setSettings(jsonObj.context, {lastCheckTime: moment()});
                getWeather(jsonObj.context);
            }
        });

        $SD.on(actionName + ".sendToPlugin", function (jsonObj) {
            weatherEndpoint = weatherEndpoint.replace("{zipCode}", jsonObj.payload.zipCode);
            $SD.api.getSettings(jsonObj.context);
        });

        function getWeather(context) {
            var weatherAjax = new XMLHttpRequest();
            weatherAjax.open("GET", weatherEndpoint);

            $SD.api.setTitle(context, "Updating\nWeather\Info");

            weatherAjax.onreadystatechange = function () {
                if (weatherAjax.readyState === 4 && weatherAjax.status === 200) {
                    weatherAjax.responseText
                    var response = JSON.parse(weatherAjax.responseText);
                    $SD.setTitle(context, response.main.temp);
                }
            }
            
            weatherAjax.send();
        }
    }

</script>

</body>

</html>
